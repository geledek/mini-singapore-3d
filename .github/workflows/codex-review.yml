name: AI Code Review with Codex

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, develop ]

jobs:
  codex-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    if: github.event.sender.type == 'User' && !endsWith(github.event.sender.login, '[bot]')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: refs/pull/${{ github.event.pull_request.number }}/merge
        fetch-depth: 0

    - name: Pre-fetch base and head refs
      run: |
        git fetch --no-tags origin \
          ${{ github.event.pull_request.base.ref }} \
          +refs/pull/${{ github.event.pull_request.number }}/head

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run Codex AI Code Review
      id: codex_review
      uses: openai/codex-action@v1
      with:
        openai-api-key: ${{ secrets.OPENAI_API_KEY }}
        prompt-file: .github/codex/prompts/code-review.md
        output-file: codex-review-output.md
        safety-strategy: drop-sudo
        sandbox: workspace-write
        codex-args: '["--full-auto"]'

    - name: Post Codex Review
      if: steps.codex_review.outputs.final-message != ''
      uses: actions/github-script@v7
      env:
        CODEX_MESSAGE: ${{ steps.codex_review.outputs.final-message }}
        WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      with:
        github-token: ${{ github.token }}
        script: |
          const codexMessage = process.env.CODEX_MESSAGE;
          if (!codexMessage || codexMessage.trim() === '') {
            console.log('No Codex feedback to post');
            return;
          }
          const workflowUrl = process.env.WORKFLOW_URL;
          const body = '## ðŸ¤– AI Code Review by Codex\n\n' + codexMessage + '\n\n---\n*Generated by [OpenAI Codex](https://platform.openai.com/docs/codex) â€¢ [Review workflow](' + workflowUrl + ')*';
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body: body
          });

    - name: Upload Codex output as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: codex-review-${{ github.event.pull_request.number }}
        path: codex-review-output.md
        retention-days: 30